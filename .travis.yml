sudo: required
dist: trusty
language: ruby

before_install:
before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install pillow
- sudo pip install cssutils
- sudo pip install docutils
- sudo pip install roman
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
branches:
  only:
  - master
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: o6CJNxMGvFX+5jyxoRrmV5r3tiFn+gIAhlmW5s3yqUf9lT4btM2ozrdF+CnEK9FeeNZmrOhpv9ZTCA5ncZrpfas35PZbSx2kh9H4t64W1IUu/RR/gVAlguvKf/Ho9zFzmN7MoIOuGG9lvNY5+Izc2ymAOS9Tb1GXwabqC2f12X73kaQvf/mDZjtjqbHUEjFPbuZKBcl8GfQxRFG2P2LV3txP0jaDnJF2uO4qiMYAPNo0JSxwOn1U7Lcfu1b1ZBaoeQRs9qlrGBa5wh3E1iP1aS9AY6QVwViz5u1Hg6gj7FtDgcUQ79XUi+P71c9yRJXmp44TboVLoWlFCx3BMK0yJMKMgNl+JKvGcrKwwrDNrX+wM0YWGH7wUoXl/uHy6jmVcQZgSq+ndA/F2VW5gUBWACjKEXey2SZNCLVA1aBM+SlkoWcbNw2dtWWdMuo6aD0R0mcmR6s/zYGED059+5rMzGvHY6F2AdaxTOfQLI457Grgcl9GAK9sAqyVc6uzTNQb2HHsyNi2h+onUZauMlfxeSZPyfSN+vZM6z+Vvw7ONo6RZIDPU0viRm4zWHvibB4zZr4W40+FnpLCwQq59BZO3warjS59VKGl0XMam8i5WJ6jtpDfABsWjLvuG4YMuX5wvJKkYsdgYufoVoHVSiTJeHs/kzTVJn1KWZXignvmSME=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  "on":
    repo: GITenberg/Samuel-Brohl-and-Company_2470
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy